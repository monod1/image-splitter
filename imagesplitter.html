import tkinter as tk
from tkinter import filedialog
from PIL import Image, ImageTk

class ImageSplitterApp:
    def __init__(self, master, image_path, cols=3, rows=3, dpi=300):
        self.master = master
        self.cols = cols
        self.rows = rows
        self.dpi = dpi

        # Load image
        self.original_img = Image.open(image_path)
        self.img = self.original_img.copy()

        # A4 size at dpi
        self.a4_width_px = int(8.27 * dpi)
        self.a4_height_px = int(11.69 * dpi)

        # Resize to fit grid size
        target_width = cols * self.a4_width_px
        target_height = rows * self.a4_height_px
        self.img = self.img.resize((target_width, target_height), Image.LANCZOS)

        # Setup canvas
        self.canvas = tk.Canvas(master, bg="white")
        self.canvas.pack(fill=tk.BOTH, expand=True)

        # Display image
        self.tk_img = ImageTk.PhotoImage(self.img)
        self.image_id = self.canvas.create_image(0, 0, anchor="nw", image=self.tk_img)

        # Draw grid
        self.draw_grid()

        # Bind resizing
        self.canvas.bind("<Configure>", self.on_resize)

    def draw_grid(self):
        self.canvas.delete("grid")
        w, h = self.img.size
        scaled_w = self.tk_img.width()
        scaled_h = self.tk_img.height()
        cell_w = scaled_w / self.cols
        cell_h = scaled_h / self.rows

        for i in range(1, self.cols):
            x = i * cell_w
            self.canvas.create_line(x, 0, x, scaled_h, fill="red", tags="grid")

        for j in range(1, self.rows):
            y = j * cell_h
            self.canvas.create_line(0, y, scaled_w, y, fill="red", tags="grid")

    def on_resize(self, event):
        # Scale image to canvas size
        resized_img = self.img.copy().resize((event.width, event.height), Image.LANCZOS)
        self.tk_img = ImageTk.PhotoImage(resized_img)
        self.canvas.itemconfig(self.image_id, image=self.tk_img)
        self.draw_grid()


if __name__ == "__main__":
    root = tk.Tk()
    root.title("Image Splitter Preview")

    # Ask user to select image
    file_path = filedialog.askopenfilename(title="Select an image", filetypes=[("Images", "*.png;*.jpg;*.jpeg")])
    if file_path:
        app = ImageSplitterApp(root, file_path, cols=3, rows=3)
        root.mainloop()
